{% extends 'layouts/sidebar_w_header.html' %}

{% from 'macros/sidebar.html' import sidebar %}


{% set menu_type = request.args.get('type', 'breakfast') %}


{% block title %}Меню{% endblock %}


{% block head %}
{{ super() }}
<link rel="stylesheet" href="/static/styles/menus/menu.css">
<link rel="stylesheet" href="/static/styles/macros/sidebar.css">
    <link rel="stylesheet" href="/static/styles/includes/dishes/dish_tile.css">
{% endblock %}

{% block top_bar %}
    <form id="filtersForm" style="display: none;"></form>

    <div class="top-bar__left">
        <h1 class="title left">
            Меню | 

            {% if menu %}
                <span class="price">{{ menu.price }}₽</span>
            {% endif %}
        </h1>
    </div>

    <div class="top-bar__right">
        <div class="filters">
            <select name="type" id="menuTypeSelect" class="menu-type" form="filtersForm">
                {% if menu_type == "breakfast" %}
                    <option value="breakfast" selected>Завтрак</option>
                    <option value="lunch">Обед</option>
                {% elif menu_type == "lunch" %}
                    <option value="breakfast">Завтрак</option>
                    <option value="lunch" selected>Обед</option>
                {% else %}
                    <option value="breakfast">Завтрак</option>
                    <option value="lunch">Обед</option>
                {% endif %}
            </select>
        </div>

        {% if current_user.roles[0].name == 'user' and menu %}
            <form class="buy-form" method="POST" action="/menu/{{ selected_date }}?type={{ menu.type }}">
                <input type="hidden" name="menu_id" value="{{ menu.id }}">
                <button class="buy-menu-btn accent" type="submit">Купить</button>
            </form>
        {% elif current_user.roles[0].name == 'cook' and menu %}
            <form class="buy-form" method="POST" action="/menu/{{ selected_date }}?type={{ menu.type }}">
                <input type="hidden" name="menu_id" value="{{ menu.id }}">
            </form>
            <button class="buy-menu-btn accent" onclick="document.location='/cook/menu/add'">Добавить</button>
        {% endif %}

    </div>
{% endblock %}


{% block sidebar %}
    {% call sidebar(header='День') %}
    <ul id="daysList" class="days-list">
        {% for date in dates %}
            {% set selected = 'day--selected' if date == selected_date else '' %}
            {% set today = ' (сегодня)' if date == today_date else '' %}

            <li class="day {{ selected }}" data-day="{{ date }}">
                <a class="day__link" href="/menu/{{ date }}?type={{ menu_type }}">{{ date | date_fM_d }}{{ today }}</a>
            </li>
        {% endfor %}

    </ul>
    {% endcall %}
{% endblock %}


{% block main %}
    {% if not menu or not menu.dishes %}
        <p class="no-menu-message"><strong>На эту дату нет меню.</strong></p>
    {% else %}

    <div class="menu-grid">
        {% for dish in menu.dishes %}
            {% include 'includes/dishes/dish_tile.html' %}
        {% endfor %}
    </div>

    {% endif %}
{% endblock %}


{% block scripts %}
    <script>
        const menuTypeSelect = document.getElementById('menuTypeSelect');
        const filtersForm = document.getElementById('filtersForm');

        menuTypeSelect.addEventListener('change', function(event) {
            filtersForm.requestSubmit();
        });
    </script>
{% endblock %}