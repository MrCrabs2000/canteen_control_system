{% extends 'base.html' %}

{% from 'macros/labeled_input.html' import labeled_input %}
{% from 'macros/labeled_class_input.html' import labeled_class_input %}

{% block title %}Профиль{% endblock %}


{% block head %}
    <link rel="stylesheet" href="/static/styles/profile.css">
    <link rel="stylesheet" href="/static/styles/macros/labeled-input.css">
    <link rel="stylesheet" href="/static/styles/macros/class-input.css">
    <link rel="stylesheet" href="/static/styles/elements/title.css">
{% endblock %}


{% block content %}
    <main>
        <form id="profile-form" action="profile/edit" method="post">
            <div id="profile-top-bar">
                <div class="title" class="left">Профиль</div>
                <div id="btns-container">
                    <button id="edit-btn" type="button">Изменить</button>
                    <button id="confirm-btn" class="accent" type="button" style="display: none">Подтвердить</button>
                    <button id="cancel-btn" class="danger" type="button" style="display: none">Отменить</button>
                </div>
            </div>
    
            <div id="profile-grid">
                <div id="main-profile-info">
                    {{ labeled_input(name='login', label='Логин', value=login, readonly=True, required=True) }}
                    {{ labeled_input(name='surname', label='Фамилия', value=surname, readonly=True, required=True) }}
                    {{ labeled_input(name='name', label='Имя', value=name, readonly=True, required=True) }}
                    {{ labeled_input(name='patronymic', label='Отчество', value=patronymic, readonly=True, required=True) }}
                    {{ labeled_class_input(value=class, readonly=True, required=True) }}
                </div>
    
                <div id="allergies" class="scrollable-container">
                    <div class="list-top-bar">
                        <label>Аллергии</label>
                        <button id="add-allergy-btn" class="add" type="button"></button>
                    </div>

                    <ul id="allergies-list" class="scrollable-list">
                        {% for allergy in allergies %}
                        <li data-content="{{ allergy }}">
                            <span>{{ allergy }}</span>
                            <div class="li-btns" style="display: none;">
                                <button class="delete-btn danger" type="button">Удалить</button>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
    
                <div id="preferences-container" class="scrollable-container">
                    <div class="list-top-bar">
                        <label>Предпочтения</label>
                        <button id="add-preference-btn" class="add" type="button"></button>
                    </div>
                    <ul id="preferences-list" class="scrollable-list">
                        {% for preference in preferences %}
                        <li data-content="{{ preference }}">
                            <span class="content">{{ preference }}</span>
                            <div class="li-btns" style="display: none;">
                                <button class="delete-btn danger" type="button">Удалить</button>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>

            <div id="hidden-inputs" style="display: none;">
                <input name="allergies" type="hidden">
                <input name="preferences" type="hidden">
            </div>

        </form>
    </main>

    <script src="{{ url_for('static', filename='scripts/profile/getListStrContent.js') }}"></script>
    <script src="{{ url_for('static', filename='scripts/profile/addProfileListItem.js') }}"></script>
    <script src="{{ url_for('static', filename='scripts/profile/submitProfileForm.js') }}"></script>
    <script src="{{ url_for('static', filename='scripts/elements/classInput.js') }}"></script>
    <script>
        const form = document.getElementById('profile-form');
        const hiddenInputsContainer = document.getElementById('hidden-inputs');

        const editButton = document.getElementById('edit-btn');
        const confirmButton = document.getElementById('confirm-btn');
        const cancelButton = document.getElementById('cancel-btn');

        const fields = document.querySelectorAll('#main-profile-info > .labeled-input > input, #main-profile-info > .labeled-input > class-input');
        let initialValues = [];
        
        let listItems = document.querySelectorAll('.scrollable-list li');
        
        const addButtons = document.querySelectorAll('button.add');

        addButtons.forEach(button => {
            button.addEventListener('click', addProfileListItem);
        })


        listItems.forEach(li => {
            li.addEventListener('mouseenter', function() {
                let btns = this.querySelector('.li-btns');
                btns.style.display = 'block';
            });
            
            li.addEventListener('mouseleave', function() {
                let btns = this.querySelector('.li-btns');
                btns.style.display = 'none';
            });

            let del_btn = li.querySelector('.delete-btn');
            del_btn.addEventListener('click', function() {
                li.remove();
                submitProfileForm(form, hiddenInputsContainer);
            });

        });


        fields.forEach(field => {
            initialValues.push(field.value);
        });


        confirmButton.addEventListener('click', function() {
            submitProfileForm(form, hiddenInputsContainer);
        });


        editButton.addEventListener('click', function() {
            fields.forEach(field => {
                field.readOnly = false;
            });

            this.style.display = 'none';
            confirmButton.style.display = 'inline-block';
            cancelButton.style.display = 'inline-block';
        });


        cancelButton.addEventListener('click', function() {
            fields.forEach((field, index) => {
                field.readOnly = true;
                field.value = initialValues[index];
            });

            this.style.display = 'none';
            confirmButton.style.display = 'none';
            editButton.style.display = 'inline-block';
        });
    </script>

{% endblock %}